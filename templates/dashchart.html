<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTURT Racing Dashboard v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Floating message counter */
        .floating-stats {
            position: fixed;
            top: 60px;
            right: 20px;
            background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 12px;
            padding: 12px 16px;
            z-index: 1000;
            min-width: 150px;
        }

        .floating-stats-title {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .floating-stats-value {
            font-size: 28px;
            font-weight: bold;
            color: #06b6d4;
            line-height: 1;
        }

        .floating-stats-time {
            font-size: 9px;
            color: #64748b;
            margin-top: 4px;
        }

        .connection-indicator.connected {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid #22c55e;
        }

        .connection-indicator.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.green {
            background: #22c55e;
        }

        .status-dot.red {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Top Bar Styles */
        .vertical-bar {
            width: 50px;
            height: 160px;
            background: linear-gradient(to top, rgba(148, 163, 184, 0.1) 0%, rgba(148, 163, 184, 0.05) 100%);
            border-radius: 25px;
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(148, 163, 184, 0.2);
        }

        .bar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            transition: height 0.3s ease;
            border-radius: 30px;
        }

        .apps-bar .bar-fill {
            background: linear-gradient(to top, #10b981, #34d399);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.5);
        }

        .brake-bar .bar-fill {
            background: linear-gradient(to top, #ef4444, #f87171);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
        }

        /* Speed Gauge */
        .speed-gauge {
            position: relative;
        }

        .circular-gauge {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.3);
        }

        .gauge-inner {
            width: 135px;
            height: 135px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1;
        }

        /* RPM Mini Gauge */
        .mini-gauge {
            position: relative;
            width: 100px;
            height: 100px;
        }

        .mini-circular-gauge {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(51, 65, 85, 0.5);
            border: 3px solid rgba(74, 222, 128, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .rpm-gauge-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(
                from -90deg,
                rgba(74, 222, 128, 0.8) 0deg,
                rgba(74, 222, 128, 0.8) var(--rpm-fill, 0deg),
                transparent var(--rpm-fill, 0deg)
            );
        }

        .mini-gauge-inner {
            width: 82px;
            height: 82px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2;
            position: relative;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 220px;
            padding: 8px;
        }

        /* Compact layout adjustments */
        .compact-spacing {
            margin-bottom: 0.75rem !important;
        }

        .compact-card {
            padding: 0.75rem !important;
        }

        /* Time display bar below charts */
        .chart-time-display {
            background: rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            padding: 8px 16px;
            margin-top: 12px;
            text-align: center;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .chart-time-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .chart-time-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
            font-family: 'Courier New', monospace;
        }

        /* Temperature Display */
        .temp-display {
            font-size: 2rem;
            font-weight: 900;
            text-align: center;
            transition: color 0.3s ease;
        }

        .temp-display.cold {
            color: #22c55e;
        }

        .temp-display.warm {
            color: #eab308;
        }

        .temp-display.hot {
            color: #ef4444;
        }

        /* Status Display */
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .status-item {
            background: rgba(51, 65, 85, 0.5);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }

        .status-label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #e2e8f0;
            font-family: 'Courier New', monospace;
        }

        .heartbeat-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .heartbeat-ok {
            background: #22c55e;
            animation: pulse-green 2s infinite;
        }

        .heartbeat-fail {
            background: #ef4444;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Error Marker on Charts */
        .error-marker {
            position: absolute;
            width: 3px;
            height: 100%;
            background: #ef4444;
            opacity: 0.8;
            z-index: 10;
        }

        /* Label toggle styles */
        .label-hidden {
            text-decoration: line-through;
            opacity: 0.5;
        }

        /* Status indicator lights */
        .status-lights {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }

        .status-light.on {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.8);
        }

        .status-light.off {
            background: #ef4444;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.8);
        }

        .status-light-label {
            font-size: 9px;
            color: #94a3b8;
            text-transform: uppercase;
        }

        /* Chart time display */
        .chart-time-display {
            margin-top: 12px;
            padding: 8px 16px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .chart-time-label {
            font-size: 10px;
            color: #94a3b8;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .chart-time-value {
            font-size: 18px;
            font-weight: bold;
            color: #06b6d4;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <!-- Connection Status -->
    <div id="connection-status" class="connection-indicator disconnected">
        <span class="status-dot red"></span>
        <span id="connection-text">Connecting...</span>
    </div>

    <!-- Floating Message Stats -->
    <div class="floating-stats">
        <div class="floating-stats-title">Messages</div>
        <div class="floating-stats-value" id="floating-message-count">0</div>
        <div class="floating-stats-time" id="floating-last-update">Waiting...</div>
    </div>

    <div class="container mx-auto px-3 py-3">
        <!-- Header -->
        <div class="glass-card rounded-lg p-3 mb-3">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        NTURT Racing Dashboard
                    </h1>
                    <p class="text-slate-400 text-sm">Real-time Telemetry System v3.0</p>
                </div>
            </div>
        </div>

        <!-- Top Control Bar -->
        <div class="glass-card rounded-lg p-4 mb-3">
            <div class="flex items-center justify-center space-x-8">
                <!-- RL Motor RPM -->
                <div class="text-center">
                    <div class="mini-gauge">
                        <div class="mini-circular-gauge" id="rpm-rl-gauge" style="--rpm-fill: 0deg">
                            <div class="rpm-gauge-bg"></div>
                            <div class="mini-gauge-inner">
                                <div id="rpm-rl-value" class="text-lg font-bold text-green-400">0</div>
                                <div class="text-sm text-slate-400">RPM</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm font-bold text-cyan-400 mt-2">RL Motor</div>
                    <div class="text-sm font-bold text-cyan-400" id="speed-rl-value">0 km/h</div>
                </div>

                <!-- Brake Bar -->
                <div class="flex flex-col items-center">
                    <div class="vertical-bar brake-bar">
                        <div class="bar-fill" id="brake-fill" style="height: 0%"></div>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-lg font-bold text-red-400">BRAKE</div>
                        <div id="brake-value" class="text-2xl font-mono text-red-300">0%</div>
                    </div>
                </div>

                <!-- Speed Gauge -->
                <div class="flex flex-col items-center">
                    <div class="speed-gauge">
                        <div class="circular-gauge" id="speed-gauge">
                            <div class="gauge-inner">
                                <div id="speed-value" class="text-3xl font-bold text-white mb-1">0</div>
                                <div class="text-base text-slate-400">km/h</div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-sm text-slate-400">Trip Distance</div>
                        <div id="trip-distance-value" class="text-xl font-bold text-cyan-400">0.00 km</div>
                    </div>
                </div>

                <!-- APPS Bar -->
                <div class="flex flex-col items-center">
                    <div class="vertical-bar apps-bar">
                        <div class="bar-fill" id="apps-fill" style="height: 0%"></div>
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-lg font-bold text-green-400">APPS</div>
                        <div id="apps-value" class="text-2xl font-mono text-green-300">0%</div>
                    </div>
                </div>

                <!-- RR Motor RPM -->
                <div class="text-center">
                    <div class="mini-gauge">
                        <div class="mini-circular-gauge" id="rpm-rr-gauge" style="--rpm-fill: 0deg">
                            <div class="rpm-gauge-bg"></div>
                            <div class="mini-gauge-inner">
                                <div id="rpm-rr-value" class="text-lg font-bold text-green-400">0</div>
                                <div class="text-sm text-slate-400">RPM</div>
                            </div>
                        </div>
                    </div>
                    <div class="text-sm font-bold text-cyan-400 mt-2">RR Motor</div>
                    <div class="text-sm font-bold text-cyan-400" id="speed-rr-value">0 km/h</div>
                </div>
            </div>
        </div>

        <!-- Main 4-Panel Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 mb-3">
            <!-- Top Left: Torque Chart -->
            <div class="glass-card rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-bold text-purple-400">Torque Over Time</h3>
                </div>
                <div class="chart-container">
                    <canvas id="torque-chart"></canvas>
                </div>
            </div>

            <!-- Top Right: RPM Chart -->
            <div class="glass-card rounded-lg p-3">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-bold text-cyan-400">RPM Over Time</h3>
                </div>
                <div class="chart-container">
                    <canvas id="rpm-chart"></canvas>
                </div>
            </div>

            <!-- Bottom Left: Motor Temperatures -->
            <div class="glass-card rounded-lg p-3">
                <h3 class="text-lg font-bold text-orange-400 mb-3">Motor Temperatures</h3>
                <div class="grid grid-cols-2 gap-3">
                    <!-- RL Motor -->
                    <div class="text-center">
                        <div class="text-sm text-white font-bold mb-2">RL Motor</div>
                        <div id="temp-rl" class="temp-display cold">--째C</div>
                        <div class="mt-2 text-xs text-slate-500">
                            MOS: <span id="temp-rl-mos" class="font-bold">--</span> | 
                            MCU: <span id="temp-rl-mcu" class="font-bold">--</span>
                        </div>
                    </div>
                    <!-- RR Motor -->
                    <div class="text-center">
                        <div class="text-sm text-white font-bold mb-2">RR Motor</div>
                        <div id="temp-rr" class="temp-display cold">--째C</div>
                        <div class="mt-2 text-xs text-slate-500">
                            MOS: <span id="temp-rr-mos" class="font-bold">--</span> | 
                            MCU: <span id="temp-rr-mcu" class="font-bold">--</span>
                        </div>
                    </div>
                    <!-- FL Motor -->
                    <div class="text-center">
                        <div class="text-sm text-white font-bold mb-2">FL Motor</div>
                        <div id="temp-fl" class="temp-display cold">--째C</div>
                        <div class="mt-2 text-xs text-slate-500">
                            MOS: <span id="temp-fl-mos" class="font-bold">--</span> | 
                            MCU: <span id="temp-fl-mcu" class="font-bold">--</span>
                        </div>
                    </div>
                    <!-- FR Motor -->
                    <div class="text-center">
                        <div class="text-sm text-white font-bold mb-2">FR Motor</div>
                        <div id="temp-fr" class="temp-display cold">--째C</div>
                        <div class="mt-2 text-xs text-slate-500">
                            MOS: <span id="temp-fr-mos" class="font-bold">--</span> | 
                            MCU: <span id="temp-fr-mcu" class="font-bold">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bottom Right: Status Display -->
            <div class="glass-card rounded-lg p-3">
                <h3 class="text-lg font-bold text-blue-400 mb-2">Status</h3>
                <div class="space-y-2">
                    <!-- RL Status -->
                    <div class="border-l-4 border-yellow-500 pl-2 py-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-yellow-400 text-sm">RL</span>
                                <div class="status-lights">
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rl-ready"></div>
                                        <div class="status-light-label">RDY</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rl-enable"></div>
                                        <div class="status-light-label">EN</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rl-fault"></div>
                                        <div class="status-light-label">FLT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rl-hv"></div>
                                        <div class="status-light-label">HV</div>
                                    </div>
                                </div>
                            </div>
                            <span class="heartbeat-indicator heartbeat-fail" data-inv="3"></span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Torque</div>
                                <div class="font-mono font-bold text-white" id="status-rl-torque">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC V</div>
                                <div class="font-mono font-bold text-white" id="status-rl-voltage">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC I</div>
                                <div class="font-mono font-bold text-white" id="status-rl-current">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Error</div>
                                <div class="font-mono font-bold text-red-400 text-[10px]" id="status-rl-error">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- RR Status -->
                    <div class="border-l-4 border-red-500 pl-2 py-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-red-400 text-sm">RR</span>
                                <div class="status-lights">
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rr-ready"></div>
                                        <div class="status-light-label">RDY</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rr-enable"></div>
                                        <div class="status-light-label">EN</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rr-fault"></div>
                                        <div class="status-light-label">FLT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-rr-hv"></div>
                                        <div class="status-light-label">HV</div>
                                    </div>
                                </div>
                            </div>
                            <span class="heartbeat-indicator heartbeat-fail" data-inv="4"></span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Torque</div>
                                <div class="font-mono font-bold text-white" id="status-rr-torque">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC V</div>
                                <div class="font-mono font-bold text-white" id="status-rr-voltage">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC I</div>
                                <div class="font-mono font-bold text-white" id="status-rr-current">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Error</div>
                                <div class="font-mono font-bold text-red-400 text-[10px]" id="status-rr-error">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- FL Status -->
                    <div class="border-l-4 border-green-500 pl-2 py-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-green-400 text-sm">FL</span>
                                <div class="status-lights">
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fl-ready"></div>
                                        <div class="status-light-label">RDY</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fl-enable"></div>
                                        <div class="status-light-label">EN</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fl-fault"></div>
                                        <div class="status-light-label">FLT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fl-hv"></div>
                                        <div class="status-light-label">HV</div>
                                    </div>
                                </div>
                            </div>
                            <span class="heartbeat-indicator heartbeat-fail" data-inv="1"></span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Torque</div>
                                <div class="font-mono font-bold text-white" id="status-fl-torque">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC V</div>
                                <div class="font-mono font-bold text-white" id="status-fl-voltage">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC I</div>
                                <div class="font-mono font-bold text-white" id="status-fl-current">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Error</div>
                                <div class="font-mono font-bold text-red-400 text-[10px]" id="status-fl-error">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- FR Status -->
                    <div class="border-l-4 border-blue-500 pl-2 py-1">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-blue-400 text-sm">FR</span>
                                <div class="status-lights">
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fr-ready"></div>
                                        <div class="status-light-label">RDY</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fr-enable"></div>
                                        <div class="status-light-label">EN</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fr-fault"></div>
                                        <div class="status-light-label">FLT</div>
                                    </div>
                                    <div class="flex flex-col items-center">
                                        <div class="status-light off" id="status-fr-hv"></div>
                                        <div class="status-light-label">HV</div>
                                    </div>
                                </div>
                            </div>
                            <span class="heartbeat-indicator heartbeat-fail" data-inv="2"></span>
                        </div>
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Torque</div>
                                <div class="font-mono font-bold text-white" id="status-fr-torque">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC V</div>
                                <div class="font-mono font-bold text-white" id="status-fr-voltage">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">DC I</div>
                                <div class="font-mono font-bold text-white" id="status-fr-current">--</div>
                            </div>
                            <div class="bg-slate-800/50 rounded p-2">
                                <div class="text-slate-400 text-[10px]">Error</div>
                                <div class="font-mono font-bold text-red-400 text-[10px]" id="status-fr-error">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="glass-card rounded-lg p-2 text-center">
            <p class="text-slate-400 text-sm">NTURT Racing Team - Enhanced Dashboard v3.0</p>
        </div>
    </div>

    <script>
        // WebSocket connection
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

        // Chart data storage - keep only 20 seconds of data (assuming ~10 updates per second = 200 data points)
        const maxDataPoints = 200; // 20 seconds at 10 Hz
        const torqueData = {
            labels: [],
            datasets: [
                { 
                    label: 'RL', 
                    data: [], 
                    borderColor: '#eab308', 
                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                },
                { 
                    label: 'RR', 
                    data: [], 
                    borderColor: '#ef4444', 
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                },
                { 
                    label: 'RL(FB)', 
                    data: [], 
                    borderColor: '#3b82f6', 
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                },
                { 
                    label: 'RR(FB)', 
                    data: [], 
                    borderColor: '#22c55e', 
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                }
            ]
        };

        const rpmData = {
            labels: [],
            datasets: [
                { 
                    label: 'FL', 
                    data: [], 
                    borderColor: '#22c55e', 
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                },
                { 
                    label: 'FR', 
                    data: [], 
                    borderColor: '#3b82f6', 
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                },
                { 
                    label: 'RL', 
                    data: [], 
                    borderColor: '#eab308', 
                    backgroundColor: 'rgba(234, 179, 8, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                },
                { 
                    label: 'RR', 
                    data: [], 
                    borderColor: '#ef4444', 
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointRadius: 0,
                    hidden: false 
                }
            ]
        };

        // Error markers storage
        const errorMarkers = [];

        // Initialize charts
        const torqueChart = new Chart(document.getElementById('torque-chart'), {
            type: 'line',
            data: torqueData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: false
                        },
                        grid: { 
                            display: true,
                            color: 'rgba(148, 163, 184, 0.3)',
                            drawBorder: true,
                            drawOnChartArea: true,
                            drawTicks: true,
                            lineWidth: 1
                        },
                        ticks: { 
                            color: '#e2e8f0',
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 8,
                            font: {
                                size: 11
                            },
                            callback: function(value, index, ticks) {
                                // Show actual timestamps from data
                                return this.getLabelForValue(value);
                            }
                        }
                    },
                    y: {
                        display: true,
                        min: -20,
                        max: 20,
                        title: {
                            display: true,
                            text: 'Torque (Nm)',
                            color: '#94a3b8',
                            font: { size: 12 }
                        },
                        ticks: {
                            stepSize: 5,
                            color: '#94a3b8'
                        },
                        grid: { 
                            display: true,
                            color: 'rgba(148, 163, 184, 0.3)',
                            drawBorder: true,
                            drawOnChartArea: true,
                            drawTicks: true,
                            lineWidth: 1
                        }
                    }
                },
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        align: 'center',
                        labels: {
                            color: '#ffffff',
                            usePointStyle: true,
                            pointStyle: 'rect',
                            boxWidth: 20,
                            boxHeight: 10,
                            padding: 15,
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        onClick: function(e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const chart = legend.chart;
                            const meta = chart.getDatasetMeta(index);
                            meta.hidden = !meta.hidden;
                            chart.update();
                        }
                    },
                    annotation: {
                        annotations: {}
                    }
                }
            }
        });

        const rpmChart = new Chart(document.getElementById('rpm-chart'), {
            type: 'line',
            data: rpmData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: false
                        },
                        grid: { 
                            display: true,
                            color: 'rgba(148, 163, 184, 0.3)',
                            drawBorder: true,
                            drawOnChartArea: true,
                            drawTicks: true,
                            lineWidth: 1
                        },
                        ticks: { 
                            color: '#e2e8f0',
                            maxRotation: 45,
                            minRotation: 45,
                            autoSkip: true,
                            maxTicksLimit: 8,
                            font: {
                                size: 11
                            },
                            callback: function(value, index, ticks) {
                                // Show actual timestamps from data
                                return this.getLabelForValue(value);
                            }
                        }
                    },
                    y: {
                        display: true,
                        min: 0,
                        max: 16000,
                        title: {
                            display: true,
                            text: 'RPM',
                            color: '#94a3b8',
                            font: { size: 12 }
                        },
                        ticks: {
                            stepSize: 2000,
                            color: '#94a3b8'
                        },
                        grid: { 
                            display: true,
                            color: 'rgba(148, 163, 184, 0.3)',
                            drawBorder: true,
                            drawOnChartArea: true,
                            drawTicks: true,
                            lineWidth: 1
                        }
                    }
                },
                plugins: {
                    legend: { 
                        display: true,
                        position: 'top',
                        align: 'center',
                        labels: {
                            color: '#ffffff',
                            usePointStyle: true,
                            pointStyle: 'rect',
                            boxWidth: 20,
                            boxHeight: 10,
                            padding: 15,
                            font: {
                                size: 12,
                                weight: 'bold'
                            }
                        },
                        onClick: function(e, legendItem, legend) {
                            const index = legendItem.datasetIndex;
                            const chart = legend.chart;
                            const meta = chart.getDatasetMeta(index);
                            meta.hidden = !meta.hidden;
                            chart.update();
                        }
                    },
                    annotation: {
                        annotations: {}
                    }
                }
            }
        });

        // WebSocket handlers
        ws.onopen = () => {
            document.getElementById('connection-status').className = 'connection-indicator connected';
            document.getElementById('connection-text').textContent = 'Connected';
            document.querySelector('.status-dot').className = 'status-dot green';
        };

        ws.onclose = () => {
            document.getElementById('connection-status').className = 'connection-indicator disconnected';
            document.getElementById('connection-text').textContent = 'Disconnected';
            document.querySelector('.status-dot').className = 'status-dot red';
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            updateDisplay(data);
        };

        // Error code lookup
        const ERROR_CODES = {
            0x0000: 'NONE',
            0x0001: 'INSTANT_OC',
            0x0002: 'RMS_OC',
            0x0003: 'INV_OT',
            0x0004: 'MOT_OT',
            0x0005: 'ENC',
            0x0006: 'CAN_OT',
            0x0007: 'GATE',
            0x0008: 'HW_OC'
        };

        function getErrorCode(status) {
            if (!status || !Array.isArray(status) || status.length < 2) return '--';
            const errorCode = status[1];
            const errorName = ERROR_CODES[errorCode] || 'UNKNOWN';
            return `${errorName} (0x${errorCode.toString(16).toUpperCase().padStart(4, '0')})`;
        }

        function parseInverterStatus(status) {
            // Parse status word byte 0 for Ready(bit1), Enable(bit2), Fault(bit3), HV(bit4)
            if (!status || !Array.isArray(status) || status.length < 1) {
                return { ready: false, enable: false, fault: false, hv: false };
            }
            
            const statusByte = status[0];
            return {
                ready: (statusByte >> 1) & 0x01,
                enable: (statusByte >> 2) & 0x01,
                fault: (statusByte >> 3) & 0x01,
                hv: (statusByte >> 4) & 0x01
            };
        }

        function updateStatusLight(elementId, isOn, inverted = false) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            // For fault indicator, on=bad (red), off=good (green)
            if (inverted) {
                element.className = isOn ? 'status-light off' : 'status-light on';
            } else {
                element.className = isOn ? 'status-light on' : 'status-light off';
            }
        }

        function updateDisplay(data) {
            // Update message count and time
            const messageCount = data.message_count || 0;
            const messageCountEl = document.getElementById('message-count');
            if (messageCountEl) {
                messageCountEl.textContent = messageCount;
            }
            document.getElementById('floating-message-count').textContent = messageCount;
            
            if (data.update_time) {
                const time = new Date(data.update_time);
                const timeStr = time.toLocaleTimeString();
                const lastUpdateEl = document.getElementById('last-update');
                if (lastUpdateEl) {
                    lastUpdateEl.textContent = timeStr;
                }
                document.getElementById('floating-last-update').textContent = timeStr;
            }

            // Update top bar controls
            if (data.velocity && data.velocity.speed_kmh !== null) {
                const speed = Math.round(data.velocity.speed_kmh);
                document.getElementById('speed-value').textContent = speed;
            }

            if (data.vcu) {
                const appsPercent = data.vcu.accel || 0;
                const brakePercent = data.vcu.brake || 0;
                
                document.getElementById('apps-value').textContent = appsPercent + '%';
                document.getElementById('apps-fill').style.height = appsPercent + '%';
                
                document.getElementById('brake-value').textContent = brakePercent + '%';
                document.getElementById('brake-fill').style.height = brakePercent + '%';
            }

            if (data.distance) {
                const distance = data.distance.trip_distance_km || 0;
                document.getElementById('trip-distance-value').textContent = distance.toFixed(2) + ' km';
            }

            // Update motor RPMs
            if (data.inverters) {
                const rl_rpm = Math.abs(data.inverters[3]?.speed || 0);  // Take absolute value
                const rr_rpm = data.inverters[4]?.speed || 0;
                
                document.getElementById('rpm-rl-value').textContent = Math.round(rl_rpm);
                document.getElementById('rpm-rr-value').textContent = Math.round(rr_rpm);
                
                // Update RPM gauge fill (0-16000 RPM maps to 0-360 degrees)
                const rl_fill = Math.min((rl_rpm / 16000) * 360, 360);
                const rr_fill = Math.min((rr_rpm / 16000) * 360, 360);
                
                document.getElementById('rpm-rl-gauge').style.setProperty('--rpm-fill', `${rl_fill}deg`);
                document.getElementById('rpm-rr-gauge').style.setProperty('--rpm-fill', `${rr_fill}deg`);
                
                // Calculate speed from RPM (formula from original code)
                const rl_speed = Math.round(Math.abs(rl_rpm * 20 * 2.54 * 3.14 * 60 / 1350000) * 100) / 100;
                const rr_speed = Math.round(rr_rpm * 20 * 2.54 * 3.14 * 60 / 1350000 * 100) / 100;
                
                document.getElementById('speed-rl-value').textContent = rl_speed + ' km/h';
                document.getElementById('speed-rr-value').textContent = rr_speed + ' km/h';

                // Update charts
                updateCharts(data);

                // Update temperatures
                updateTemperatures(data);

                // Update status displays
                updateStatus(data);
            }
        }

        function updateCharts(data) {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours % 12 || 12;
            const timestamp = `${displayHours}:${minutes}:${seconds} ${ampm}`;

            // Add new data point
            if (torqueData.labels.length >= maxDataPoints) {
                torqueData.labels.shift();
                rpmData.labels.shift();
                torqueData.datasets.forEach(ds => ds.data.shift());
                rpmData.datasets.forEach(ds => ds.data.shift());
                
                // Shift all error marker positions as data scrolls left
                const annotations = torqueChart.options.plugins.annotation.annotations;
                Object.keys(annotations).forEach(key => {
                    if (annotations[key].xMin > 0) {
                        annotations[key].xMin--;
                        annotations[key].xMax--;
                    } else {
                        // Remove markers that have scrolled off the left side
                        delete annotations[key];
                    }
                });
            }

            torqueData.labels.push(timestamp);
            rpmData.labels.push(timestamp);

            // Update torque data: RL, RR, RL(FB), RR(FB)
            const rl = data.inverters[3];  // RL motor
            const rr = data.inverters[4];  // RR motor
            
            if (rl) {
                torqueData.datasets[0].data.push(rl.target_torque || 0);  // RL target
                torqueData.datasets[2].data.push(rl.torque || 0);  // RL feedback
                
                // Check for RL error
                if (rl.status && Array.isArray(rl.status) && rl.status.length >= 2) {
                    const errorCode = rl.status[1];
                    if (errorCode !== 0x0000 && errorCode !== null) {
                        const markerId = `error-${Date.now()}-rl`;
                        torqueChart.options.plugins.annotation.annotations[markerId] = {
                            type: 'line',
                            xMin: torqueData.labels.length - 1,
                            xMax: torqueData.labels.length - 1,
                            borderColor: '#ef4444',
                            borderWidth: 3,
                            label: {
                                display: true,
                                content: 'RL',
                                position: 'start',
                                color: '#ffffff',
                                backgroundColor: 'rgba(239, 68, 68, 0.8)'
                            }
                        };
                    }
                }
            } else {
                torqueData.datasets[0].data.push(0);
                torqueData.datasets[2].data.push(0);
            }
            
            if (rr) {
                torqueData.datasets[1].data.push(rr.target_torque || 0);  // RR target
                torqueData.datasets[3].data.push(rr.torque || 0);  // RR feedback
                
                // Check for RR error
                if (rr.status && Array.isArray(rr.status) && rr.status.length >= 2) {
                    const errorCode = rr.status[1];
                    if (errorCode !== 0x0000 && errorCode !== null) {
                        const markerId = `error-${Date.now()}-rr`;
                        torqueChart.options.plugins.annotation.annotations[markerId] = {
                            type: 'line',
                            xMin: torqueData.labels.length - 1,
                            xMax: torqueData.labels.length - 1,
                            borderColor: '#ef4444',
                            borderWidth: 3,
                            label: {
                                display: true,
                                content: 'RR',
                                position: 'start',
                                color: '#ffffff',
                                backgroundColor: 'rgba(239, 68, 68, 0.8)'
                            }
                        };
                    }
                }
            } else {
                torqueData.datasets[1].data.push(0);
                torqueData.datasets[3].data.push(0);
            }

            // Update RPM data for all 4 motors (no error markers)
            for (let i = 1; i <= 4; i++) {
                const inv = data.inverters[i];
                if (inv) {
                    rpmData.datasets[i - 1].data.push(inv.speed || 0);
                    if (i === 3 && inv.speed !== null) {
                        // RL motor speed is negative in some cases, take absolute value
                        rpmData.datasets[i - 1].data[rpmData.datasets[i - 1].data.length - 1] = Math.abs(inv.speed);
                    }
                } else {
                    rpmData.datasets[i - 1].data.push(0);
                }
            }

            torqueChart.update();
            rpmChart.update();
        }

        function updateTemperatures(data) {
            const motors = ['fl', 'fr', 'rl', 'rr'];
            
            for (let i = 0; i < 4; i++) {
                const motorName = motors[i];
                const inv = data.inverters[i + 1];
                
                if (inv && inv.motor_temp !== null) {
                    const temp = inv.motor_temp;
                    const tempElement = document.getElementById(`temp-${motorName}`);
                    const mosElement = document.getElementById(`temp-${motorName}-mos`);
                    const mcuElement = document.getElementById(`temp-${motorName}-mcu`);
                    
                    tempElement.textContent = temp.toFixed(1) + '째C';
                    
                    // Color coding for motor temp
                    if (temp < 50) {
                        tempElement.className = 'temp-display cold';
                    } else if (temp < 70) {
                        tempElement.className = 'temp-display warm';
                    } else {
                        tempElement.className = 'temp-display hot';
                    }
                    
                    // MOS temperature with color coding
                    if (mosElement && inv.mos_temp !== null) {
                        const mosTemp = inv.mos_temp;
                        mosElement.textContent = mosTemp.toFixed(1) + '째C';
                        if (mosTemp >= 70) {
                            mosElement.style.color = '#ef4444'; // Red
                        } else {
                            mosElement.style.color = ''; // Default
                        }
                    }
                    
                    // MCU temperature with color coding
                    if (mcuElement && inv.mcu_temp !== null) {
                        const mcuTemp = inv.mcu_temp;
                        mcuElement.textContent = mcuTemp.toFixed(1) + '째C';
                        if (mcuTemp >= 70) {
                            mcuElement.style.color = '#ef4444'; // Red
                        } else {
                            mcuElement.style.color = ''; // Default
                        }
                    }
                }
            }
        }

        function updateStatus(data) {
            const motors = ['fl', 'fr', 'rl', 'rr'];
            
            for (let i = 0; i < 4; i++) {
                const motorName = motors[i];
                const inv = data.inverters[i + 1];
                
                if (inv) {
                    // Torque
                    const torqueEl = document.getElementById(`status-${motorName}-torque`);
                    if (torqueEl && inv.torque !== null) {
                        torqueEl.textContent = inv.torque.toFixed(2);
                    }
                    
                    // DC Voltage
                    const voltageEl = document.getElementById(`status-${motorName}-voltage`);
                    if (voltageEl && inv.dc_voltage !== null) {
                        voltageEl.textContent = inv.dc_voltage.toFixed(1) + 'V';
                    }
                    
                    // DC Current
                    const currentEl = document.getElementById(`status-${motorName}-current`);
                    if (currentEl && inv.dc_current !== null) {
                        currentEl.textContent = inv.dc_current.toFixed(1) + 'A';
                    }
                    
                    // Error Code
                    const errorEl = document.getElementById(`status-${motorName}-error`);
                    if (errorEl) {
                        errorEl.textContent = getErrorCode(inv.status);
                    }
                    
                    // Status lights (Ready, Enable, Fault, HV)
                    const statusBits = parseInverterStatus(inv.status);
                    updateStatusLight(`status-${motorName}-ready`, statusBits.ready);
                    updateStatusLight(`status-${motorName}-enable`, statusBits.enable);
                    updateStatusLight(`status-${motorName}-fault`, statusBits.fault, true); // Inverted: fault=bad
                    updateStatusLight(`status-${motorName}-hv`, statusBits.hv);
                    
                    // Heartbeat
                    const heartbeatEl = document.querySelector(`[data-inv="${i + 1}"]`);
                    if (heartbeatEl) {
                        if (inv.heartbeat === true) {
                            heartbeatEl.className = 'heartbeat-indicator heartbeat-ok';
                        } else {
                            heartbeatEl.className = 'heartbeat-indicator heartbeat-fail';
                        }
                    }
                }
            }
        }

        // Initial data fetch
        fetch('/api/data')
            .then(response => response.json())
            .then(data => updateDisplay(data))
            .catch(error => console.error('Error fetching initial data:', error));
    </script>
</body>
</html>
