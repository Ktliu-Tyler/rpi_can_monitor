<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NTUR GPS Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Dark Theme Customization */
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
        }
        
        .glass-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: all 0.4s ease;
        }
        
        .glass-card:hover {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(59, 130, 246, 0.4);
            box-shadow: 
                0 10px 30px rgba(59, 130, 246, 0.2),
                0 0 30px rgba(59, 130, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }
        
        .neon-border {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        .speed-gauge {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto;
        }
        
        .circular-gauge {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: conic-gradient(from 270deg, #3b82f6 0deg, #3b82f6 var(--gauge-angle), #1f2937 var(--gauge-angle), #1f2937 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid #1f2937;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .gauge-inner {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: rgba(30, 41, 59, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        
        .mini-gauge {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }
        
        .mini-circular-gauge {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(from 270deg, #10b981 0deg, #10b981 var(--gauge-angle), #1f2937 var(--gauge-angle), #1f2937 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid #1f2937;
        }
        
        .mini-gauge-inner {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: rgba(30, 41, 59, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            text-align: center;
        }
        
        .status-ok { color: #10b981; font-weight: bold; text-shadow: 0 0 10px #10b981; }
        .status-bad { color: #ef4444; font-weight: bold; text-shadow: 0 0 10px #ef4444; }
        .status-unknown { color: #6b7280; }
        
        .map-dark {
            filter: invert(1) hue-rotate(180deg);
            border-radius: 8px;
        }
        
        /* GPS Ripple Effect for Dark Theme */
        .ripple-marker-dark {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #60a5fa;
            position: relative;
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.8);
            filter: invert(1) hue-rotate(180deg);
        }
        
        .ripple-marker-dark::before,
        .ripple-marker-dark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            border: 2px solid #60a5fa;
            transform: translate(-50%, -50%);
            animation: ripple-dark 2s infinite;
        }
        
        .ripple-marker-dark::after {
            animation-delay: 1s;
        }
        
        @keyframes ripple-dark {
            0% {
                width: 0;
                height: 0;
                opacity: 1;
            }
            100% {
                width: 60px;
                height: 60px;
                opacity: 0;
            }
        }
        
        .connection-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: bold;
        }
        
        .connected {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid #10b981;
        }
        
        .disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #3b82f6;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            background: rgba(15, 23, 42, 0.9);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .chart-container:hover {
            background: rgba(15, 23, 42, 0.95);
            border-color: #3b82f6;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }
        
        .digital-clock {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }
        
        .path-line {
            stroke: #3b82f6;
            stroke-width: 3;
            fill: none;
            opacity: 0.8;
        }
        
        #map {
            height: calc(100vh - 200px);
            min-height: 500px;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(30, 41, 59, 0.9);
            padding: 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Connection Status -->
    <div id="connection-status" class="connection-indicator disconnected">
        <span id="connection-text">Connecting...</span>
    </div>

    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="glass-card neon-border rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent">
                        NTURT GPS Tracker
                    </h1>
                    <p class="text-slate-400 mt-2">Real-time GPS & Navigation System</p>
                </div>
                <div class="text-right">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs text-slate-400 mb-1">System Time</div>
                            <div class="digital-clock text-cyan-400" id="current-time">00:00:00</div>
                            <div class="text-xs text-slate-500" id="current-date">Loading...</div>
                        </div>
                        <div>
                            <div class="text-xs text-slate-400 mb-1">Data Time</div>
                            <div class="digital-clock text-orange-400" id="data-time">--:--:--</div>
                            <div class="text-xs text-slate-500" id="data-date">No Data</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Speed Gauges Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <!-- Current Speed -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-lg font-bold text-center mb-4 text-cyan-400">Current Speed</h3>
                <div class="speed-gauge">
                    <div class="circular-gauge" id="current-speed-gauge">
                        <div class="gauge-inner">
                            <div id="current-speed-value" class="text-2xl font-bold text-white">0</div>
                            <div class="text-sm text-slate-400">km/h</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Max Speed -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-lg font-bold text-center mb-4 text-green-400">Max Speed</h3>
                <div class="mini-gauge">
                    <div class="mini-circular-gauge" id="max-speed-gauge">
                        <div class="mini-gauge-inner">
                            <div id="max-speed-value" class="text-lg font-bold text-green-400">0</div>
                            <div class="text-xs text-slate-400">km/h</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Average Speed -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-lg font-bold text-center mb-4 text-yellow-400">Avg Speed</h3>
                <div class="mini-gauge">
                    <div class="mini-circular-gauge" id="avg-speed-gauge">
                        <div class="mini-gauge-inner">
                            <div id="avg-speed-value" class="text-lg font-bold text-yellow-400">0</div>
                            <div class="text-xs text-slate-400">km/h</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Distance -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-lg font-bold text-center mb-4 text-purple-400">Total Distance</h3>
                <div class="text-center">
                    <div id="total-distance-value" class="text-3xl font-bold text-purple-400">0.0</div>
                    <div class="text-sm text-slate-400">km</div>
                    <div class="mt-2">
                        <div class="text-sm text-slate-400">Trip Time</div>
                        <div id="trip-time" class="text-lg font-bold text-purple-300">00:00:00</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GPS Data Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- GPS Coordinates -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                    GPS Coordinates
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Latitude:</span>
                        <span id="gps-lat" class="font-mono text-blue-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Longitude:</span>
                        <span id="gps-lon" class="font-mono text-blue-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Altitude:</span>
                        <span id="gps-alt" class="font-mono text-blue-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Status:</span>
                        <span id="gps-status" class="font-mono">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Satellites:</span>
                        <span id="gps-satellites" class="font-mono text-green-400">N/A</span>
                    </div>
                </div>
            </div>

            <!-- Velocity Components -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
                    Velocity Components
                </h3>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-slate-400">Linear X:</span>
                        <span id="velocity-x" class="font-mono text-green-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Linear Y:</span>
                        <span id="velocity-y" class="font-mono text-green-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Linear Z:</span>
                        <span id="velocity-z" class="font-mono text-green-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Magnitude:</span>
                        <span id="velocity-magnitude" class="font-mono text-cyan-400">N/A</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-slate-400">Heading:</span>
                        <span id="gps-heading" class="font-mono text-yellow-400">N/A</span>
                    </div>
                </div>
            </div>

            <!-- Map Controls -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 flex items-center">
                    <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                    Map Controls
                </h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400">Show Path:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="show-path-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-400">Follow Vehicle:</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="follow-vehicle-toggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button id="clear-path-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition-colors">
                        Clear Path
                    </button>
                    <button id="center-map-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition-colors">
                        Center on Vehicle
                    </button>
                    <div class="text-sm text-slate-400">
                        Path Points: <span id="path-points-count" class="text-cyan-400">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map and Chart Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Large Map -->
            <div class="lg:col-span-2 glass-card rounded-lg p-4 relative">
                <h3 class="text-xl font-bold mb-4 text-blue-400">GPS Map View</h3>
                <div id="map" class="map-dark rounded-lg"></div>
            </div>

            <!-- Speed Chart -->
            <div class="glass-card rounded-lg p-6">
                <h3 class="text-xl font-bold mb-4 text-cyan-400">Speed History</h3>
                <div class="chart-container">
                    <canvas id="speed-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let ws;
        let map;
        let vehicleMarker = null;
        let pathPoints = [];
        let pathPolyline = null;
        let mapInitialized = false;
        let speedChart;
        
        // Statistics tracking
        let maxSpeed = 0;
        let totalDistance = 0;
        let speedHistory = [];
        let startTime = null;
        let lastPosition = null;
        
        // Chart data
        let chartData = {
            labels: [],
            speeds: []
        };
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            initializeMap();
            initializeSpeedChart();
            initializeClock();
            initializeEventListeners();
            console.log('GPS Dashboard initialized');
        });

        function initializeWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
            
            ws.onopen = function() {
                updateConnectionStatus(true);
            };

            ws.onclose = function() {
                updateConnectionStatus(false);
                setTimeout(initializeWebSocket, 3000);
            };

            ws.onerror = function() {
                updateConnectionStatus(false);
            };

            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                updateGPSDisplay(data);
            };
        }

        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connection-status');
            const text = document.getElementById('connection-text');
            
            if (connected) {
                indicator.className = 'connection-indicator connected';
                text.textContent = 'GPS Connected';
            } else {
                indicator.className = 'connection-indicator disconnected';
                text.textContent = 'GPS Disconnected';
            }
        }

        function initializeMap() {
            map = L.map('map').setView([0, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        function initializeSpeedChart() {
            const ctx = document.getElementById('speed-chart').getContext('2d');
            speedChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Speed (km/h)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e2e8f0' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        y: {
                            min: 0,
                            max: 70,
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function initializeClock() {
            function updateClock() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('zh-TW', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateString = now.toLocaleDateString('zh-TW', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                document.getElementById('current-time').textContent = timeString;
                document.getElementById('current-date').textContent = dateString;
            }
            
            updateClock();
            setInterval(updateClock, 1000);
        }

        function initializeEventListeners() {
            // Show path toggle
            document.getElementById('show-path-toggle').addEventListener('change', function() {
                if (pathPolyline) {
                    if (this.checked) {
                        pathPolyline.addTo(map);
                    } else {
                        map.removeLayer(pathPolyline);
                    }
                }
            });

            // Clear path button
            document.getElementById('clear-path-btn').addEventListener('click', function() {
                clearPath();
            });

            // Center map button
            document.getElementById('center-map-btn').addEventListener('click', function() {
                if (vehicleMarker && mapInitialized) {
                    map.setView(vehicleMarker.getLatLng(), 15);
                }
            });
        }

        function updateGPSDisplay(data) {
            try {
                // Update data timestamp
                if (data.timestamp) {
                    const dataTime = new Date(data.timestamp);
                    const dataTimeString = dataTime.toLocaleTimeString('zh-TW', { 
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    const dataDateString = dataTime.toLocaleDateString('zh-TW', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    document.getElementById('data-time').textContent = dataTimeString;
                    document.getElementById('data-date').textContent = dataDateString;
                } else {
                    document.getElementById('data-time').textContent = '--:--:--';
                    document.getElementById('data-date').textContent = 'No Data';
                }

                // Update GPS coordinates
                if (data.gps) {
                    document.getElementById('gps-lat').textContent = formatValue(data.gps.lat, '°', 7);
                    document.getElementById('gps-lon').textContent = formatValue(data.gps.lon, '°', 7);
                    document.getElementById('gps-alt').textContent = formatValue(data.gps.alt, 'm', 1);
                    document.getElementById('gps-status').innerHTML = data.gps.status !== null ? 
                        `<span class="status-ok">ACTIVE</span>` : '<span class="status-bad">NO FIX</span>';
                    
                    // Simulate satellite count (you can replace this with real data)
                    document.getElementById('gps-satellites').textContent = "NO DATA";
                    
                    updateMapPosition(data.gps.lat, data.gps.lon);
                    calculateDistance(data.gps.lat, data.gps.lon);
                }

                // Update velocity data
                if (data.velocity) {
                    document.getElementById('velocity-x').textContent = formatValue(data.velocity.linear_x, 'm/s', 3);
                    document.getElementById('velocity-y').textContent = formatValue(data.velocity.linear_y, 'm/s', 3);
                    document.getElementById('velocity-z').textContent = formatValue(data.velocity.linear_z, 'm/s', 3);
                    document.getElementById('velocity-magnitude').textContent = formatValue(data.velocity.magnitude, 'm/s', 3);
                    
                    // Calculate heading from velocity components
                    const heading = calculateHeading(data.velocity.linear_x, data.velocity.linear_y);
                    document.getElementById('gps-heading').textContent = heading !== null ? heading.toFixed(1) + '°' : 'N/A';
                    
                    // Update speed gauges
                    const currentSpeed = data.velocity.speed_kmh || 0;
                    updateSpeedGauges(currentSpeed);
                    updateSpeedChart(currentSpeed);
                }
            } catch (error) {
                console.error('Error updating GPS display:', error);
            }
        }

        function updateMapPosition(lat, lon) {
            if (lat !== null && lon !== null && !isNaN(lat) && !isNaN(lon) && lat !== 0 && lon !== 0) {
                const latLng = [lat, lon];
                
                // Initialize map view on first valid GPS data
                if (!mapInitialized) {
                    map.setView(latLng, 15);
                    mapInitialized = true;
                    startTime = Date.now();
                }
                
                // Update or create vehicle marker
                if (vehicleMarker) {
                    vehicleMarker.setLatLng(latLng);
                } else {
                    const rippleIcon = L.divIcon({
                        className: 'ripple-marker-dark',
                        html: '',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    vehicleMarker = L.marker(latLng, { icon: rippleIcon }).addTo(map)
                        .bindPopup('Vehicle Position');
                }
                
                // Add to path
                addToPath(latLng);
                
                // Follow vehicle if enabled
                const followToggle = document.getElementById('follow-vehicle-toggle');
                if (followToggle.checked && map.getZoom() >= 10) {
                    map.setView(latLng, map.getZoom());
                }
            }
        }

        function addToPath(latLng) {
            pathPoints.push(latLng);
            
            // Limit path points to prevent performance issues
            if (pathPoints.length > 1000) {
                pathPoints.shift();
            }
            
            // Update path polyline
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
            }
            
            if (pathPoints.length > 1) {
                pathPolyline = L.polyline(pathPoints, {
                    color: '#3b82f6',
                    weight: 3,
                    opacity: 0.8
                });
                
                const showPathToggle = document.getElementById('show-path-toggle');
                if (showPathToggle.checked) {
                    pathPolyline.addTo(map);
                }
            }
            
            // Update path points counter
            document.getElementById('path-points-count').textContent = pathPoints.length;
        }

        function clearPath() {
            pathPoints = [];
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
                pathPolyline = null;
            }
            document.getElementById('path-points-count').textContent = '0';
            
            // Reset statistics
            totalDistance = 0;
            maxSpeed = 0;
            startTime = Date.now();
            lastPosition = null;
            speedHistory = [];
            
            updateStatistics();
        }

        function calculateDistance(lat, lon) {
            if (lastPosition) {
                const distance = haversineDistance(
                    lastPosition.lat, lastPosition.lon,
                    lat, lon
                );
                totalDistance += distance;
            }
            lastPosition = { lat, lon };
            updateStatistics();
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calculateHeading(vx, vy) {
            if (vx === null || vy === null || vx === undefined || vy === undefined) {
                return null;
            }
            let heading = Math.atan2(vy, vx) * 180 / Math.PI;
            heading = (heading + 360) % 360; // Normalize to 0-360
            return heading;
        }

        function updateSpeedGauges(currentSpeed) {
            // Update current speed gauge
            const speedPercentage = Math.min(currentSpeed / 200, 1);
            const speedAngle = speedPercentage * 270;
            document.getElementById('current-speed-gauge').style.setProperty('--gauge-angle', speedAngle + 'deg');
            document.getElementById('current-speed-value').textContent = currentSpeed.toFixed(1);
            
            // Update max speed
            if (currentSpeed > maxSpeed) {
                maxSpeed = currentSpeed;
                const maxPercentage = Math.min(maxSpeed / 200, 1);
                const maxAngle = maxPercentage * 270;
                document.getElementById('max-speed-gauge').style.setProperty('--gauge-angle', maxAngle + 'deg');
                document.getElementById('max-speed-value').textContent = maxSpeed.toFixed(1);
            }
            
            // Store speed for average calculation
            speedHistory.push(currentSpeed);
            if (speedHistory.length > 100) { // Keep last 100 readings
                speedHistory.shift();
            }
            
            // Calculate and update average speed
            const avgSpeed = speedHistory.reduce((a, b) => a + b, 0) / speedHistory.length;
            const avgPercentage = Math.min(avgSpeed / 200, 1);
            const avgAngle = avgPercentage * 270;
            document.getElementById('avg-speed-gauge').style.setProperty('--gauge-angle', avgAngle + 'deg');
            document.getElementById('avg-speed-value').textContent = avgSpeed.toFixed(1);
        }

        function updateSpeedChart(currentSpeed) {
            const now = new Date().toLocaleTimeString();
            
            chartData.labels.push(now);
            chartData.speeds.push(currentSpeed);
            
            // Limit chart data points
            const maxPoints = 30;
            if (chartData.labels.length > maxPoints) {
                chartData.labels.shift();
                chartData.speeds.shift();
            }
            
            speedChart.data.labels = chartData.labels;
            speedChart.data.datasets[0].data = chartData.speeds;
            speedChart.update('none');
        }

        function updateStatistics() {
            // Update total distance
            document.getElementById('total-distance-value').textContent = totalDistance.toFixed(2);
            
            // Update trip time
            if (startTime) {
                const elapsed = Date.now() - startTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                const tripTimeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                document.getElementById('trip-time').textContent = tripTimeString;
            }
        }

        // Utility function to format values
        function formatValue(value, suffix = '', decimals = 2) {
            if (value === null || value === undefined) {
                return 'N/A';
            }
            if (typeof value === 'number') {
                return value.toFixed(decimals) + suffix;
            }
            return value.toString() + suffix;
        }

        // Update statistics every second
        setInterval(updateStatistics, 1000);

        // Initial data fetch
        fetch('/api/data')
            .then(response => response.json())
            .then(data => updateGPSDisplay(data))
            .catch(error => console.error('Error fetching initial data:', error));
    </script>
</body>
</html>